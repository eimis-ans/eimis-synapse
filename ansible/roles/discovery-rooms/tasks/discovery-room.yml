---
- name: Get the room id of the previous room with the alias discoveryroom
  uri:
    url: "http://{{ matrix.server_name }}/_matrix/client/v3/directory/room/%23discoveryroom%3A{{matrix.server_name}}?roomAlias=%23discoveryroom%3A{{matrix.server_name}}"
    method: GET
    status_code: 200, 404   # allow 404 when no alias exists
    body_format: json
    use_proxy: false
    return_content: yes
    follow_redirects: all
    headers:
      Authorization: "Bearer {{ admin_access_token }}"
  register: previous_discovery_room

- name: Print the previous discovery_room room id
  ansible.builtin.debug:
    var: previous_discovery_room.json.room_id

- name: Delete previous room and move all users to somewhere
  uri:
    url: "http://{{ matrix.server_name }}/_synapse/admin/v1/rooms/{{ previous_discovery_room.json.room_id }}"
    method: DELETE
    body: "{{ lookup('template', 'old_room.json') }}"
    status_code: 200, 404   # allow 404 when no alias exists
    body_format: json
    use_proxy: false
    return_content: yes
    follow_redirects: all
    headers:
      Authorization: "Bearer {{ admin_access_token }}"
  ignore_errors: yes

- name: Create new discovery room unencrypted v9 with alias
  uri:
    url: "http://{{ matrix.server_name }}/_matrix/client/v3/createRoom"
    method: POST
    body: "{{ lookup('template', 'discovery_room.json') }}"
    status_code: 200, 201
    body_format: json
    use_proxy: false
    return_content: yes
    follow_redirects: all
    headers:
      Authorization: "Bearer {{ dummy_access_token }}"
  register: discovery_room

- name: Print the new discovery_room room id
  ansible.builtin.debug:
    var: discovery_room.json.room_id
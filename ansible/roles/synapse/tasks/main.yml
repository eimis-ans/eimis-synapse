---
- name: Add ananace-charts helm repository
  kubernetes.core.helm_repository:
    name: ananace-charts
    repo_url: "https://ananace.gitlab.io/charts"

- name: install matrix-synapse helm chart
  kubernetes.core.helm:
    name: matrix-synapse
    chart_ref: ananace-charts/matrix-synapse
    release_state: "{{ absent_or_present }}"
    release_namespace: default
    release_values:
      synapse:
        strategy:
          type: Recreate
      serverName: "{{ matrix.server_name }}"
      config:
        enableRegistration: true
      ingress:
        className: nginx
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
          external-dns.alpha.kubernetes.io/hostname: "{{ matrix.server_name }}"
        tls:
          - hosts :
            - "{{ matrix.server_name }}"
            secretName: "matrix-tls-secret"
      wellknown:
        enabled: true
      extraConfig:
        enable_registration: true
        registrations_require_3pid:
          - email
        enable_registration_without_verification: false
        email:
          smtp_host: "{{ matrix.smtp_host }}"
          smtp_port: 25
          smtp_user: "{{ matrix.smtp_user }}"
          smtp_pass: "{{ matrix.smtp_pass }}"
          notif_from: "Your Friendly %(app)s homeserver <noreply@{{ matrix.server_name }}>"
    update_repo_cache: yes
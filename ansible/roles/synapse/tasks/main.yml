---
- name: Add ananace-charts helm repository
  kubernetes.core.helm_repository:
    name: ananace-charts
    repo_url: "https://ananace.gitlab.io/charts"

- name: install matrix-synapse helm chart
  kubernetes.core.helm:
    name: matrix-synapse
    chart_ref: ananace-charts/matrix-synapse
    release_state: "{{ absent_or_present }}"
    release_namespace: default
    release_values:
      synapse:
        strategy:
          type: Recreate
      serverName: "{{ matrix.server_name }}"
      config:
        enableRegistration: true
      ingress:
        className: nginx
        annotations:
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
          external-dns.alpha.kubernetes.io/hostname: "{{ matrix.server_name }}"
        tls:
          - hosts :
            - "{{ matrix.server_name }}"
            secretName: "matrix-tls-secret"
      wellknown:
        enabled: true
      extraConfig:
        allow_public_rooms_over_federation: true
        enable_registration_without_verification: false
        registrations_require_3pid:
          - email
        email:
          smtp_host: "{{ matrix.smtp_host }}"
          # FIXME smtp_port set with ansible variable is consider as string and not int
          # smtp_port: "{{ matrix.smtp_port }}"
          smtp_port: 587
          smtp_user: "{{ matrix.smtp_user }}"
          smtp_pass: "{{ matrix.smtp_pass }}"
          notif_from: "Your Friendly %(app)s homeserver <noreply@{{ matrix.server_name }}>"
        oidc_providers:
          - idp_id: keycloak
            idp_name: "Keycloak IdP"
            issuer: "https://{{ keycloak.server_name }}/realms/psc-realm"
            client_id: "{{ keycloak.client_id }}"
            client_secret: "{{ keycloak.client_secret }}"
            scopes: ["openid", "profile"]
            user_mapping_provider:
              config:
                localpart_template: "{% raw %}{{ user.preferred_username }}{% endraw %}"
                display_name_template: "{% raw %}{{ user.name }}{% endraw %}"
            backchannel_logout_enabled: true # Optional
          - idp_id: psc
            idp_name: "Pro Sant√© Connect"
            idp_icon: "mxc://matrix.develop.eimis.incubateur.net/fmgwqNHTZIllxFNZRKzKgfAp"
            discover: false
            issuer: "{{ prosante_connect.issuer }}"
            authorization_endpoint: "{{ prosante_connect.authorization_endpoint }}"
            token_endpoint: "{{ prosante_connect.token_endpoint }}"
            userinfo_endpoint: "{{ prosante_connect.userinfo_endpoint }}"
            jwks_uri: "{{ prosante_connect.jwks_uri }}"
            client_id: "{{ prosante_connect.client_id }}"
            client_secret: "{{ prosante_connect.client_secret }}"
            scopes: ["openid", "scope_all"]
            user_mapping_provider:
              config:
                localpart_template: "{% raw %}{{ user.preferred_username }}{% endraw %}"
                display_name_template: "{% raw %}{{ user.name }}{% endraw %}"
            backchannel_logout_enabled: true # Optional
    update_repo_cache: yes

- name: wait for the matrix-synapse replicaset to be ready
  shell: "kubectl get deployments.apps matrix-synapse -o jsonpath=\"{$.status.conditions}\" |jq '.[] | select(.reason | test(\"NewReplicaSetAvailable\")).message'"
  register: rs_message
  until: rs_message.stdout.find("successfully") != -1
  retries: 30
  delay: 2
#
#- name: "DEBUG rs_message"
#  debug:
#    msg: "{{ rs_message }}"
#
#- name: retrieve the matrix-synapse replicaset ref
#  shell: "echo \"{{ rs_message.stdout }}\" | cut -d'\"' -f 2"
#  register: pod_ref
#
#- name: "DEBUG pod_ref"
#  debug:
#    msg: "{{ pod_ref }}"